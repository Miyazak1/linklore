# LinkLore 宝塔面板部署 - 一步一步操作指南

**当前状态**：已打开宝塔面板，已删除之前的网站，数据库为空

---

## 第一步：检查并安装必需软件（10分钟）

### 1.1 检查已安装的软件

在宝塔面板左侧菜单，点击 **软件商店**

查看以下软件是否已安装（如果已安装会显示"已安装"，未安装会显示"安装"）：

- [ ] **Nginx**（必须）
- [ ] **Node.js 版本管理器**（必须）
- [ ] **PM2 管理器**（推荐）或手动安装 PM2
- [ ] **PostgreSQL**（必须）
- [ ] **Redis**（必须）

### 1.2 安装 Node.js 版本管理器

1. 在 **软件商店** 页面，顶部搜索框输入：`Node.js 版本管理器`
2. 找到 **Node.js 版本管理器**，点击右侧的 **安装** 按钮
3. 等待安装完成（约1-2分钟）
4. 安装完成后，点击 **设置** 按钮
5. 在打开的页面中，点击 **Node版本** 标签
6. 点击 **安装新版本** 按钮
7. 选择 **20.11.0** 或更高的 20.x 版本
8. 点击 **安装**，等待安装完成

**验证**：点击宝塔面板左侧的 **终端**，输入：
```bash
node -v
```
应该显示：`v20.x.x`

### 1.3 安装 PM2 管理器（推荐方式）

1. 在 **软件商店** 页面，搜索：`PM2 管理器`
2. 找到 **PM2 管理器**，点击 **安装**
3. 等待安装完成

**或者手动安装**（如果找不到 PM2 管理器）：
1. 点击左侧 **终端**
2. 输入命令：
```bash
npm install -g pm2
```
3. 验证：
```bash
pm2 -v
```

### 1.4 安装 PostgreSQL

1. 在 **软件商店** 页面，搜索：`PostgreSQL`
2. 找到 **PostgreSQL**（版本 14 或 15），点击 **安装**
3. **重要**：安装过程中会要求设置 **root 密码**，请设置一个强密码并**记录下来**
4. 等待安装完成（约3-5分钟）

**记录信息**：
- 数据库端口：`5432`（默认）
- root 密码：`你刚才设置的密码`

### 1.5 安装 Redis

1. 在 **软件商店** 页面，搜索：`Redis`
2. 找到 **Redis**（版本 7.x），点击 **安装**
3. **重要**：安装完成后，点击 **设置** 按钮
4. 在设置页面，找到 **密码设置** 或 **requirepass**
5. 设置一个强密码并**记录下来**
6. 点击 **保存** 或 **重启** Redis

**记录信息**：
- Redis 端口：`6379`（默认）
- Redis 密码：`你刚才设置的密码`

### 1.6 检查 Nginx

1. 在 **软件商店** 页面，搜索：`Nginx`
2. 确认已安装（显示"已安装"）
3. 如果未安装，点击 **安装**

---

## 第二步：安装系统依赖 LibreOffice（2分钟）

1. 点击宝塔面板左侧的 **终端**
2. 在终端中输入以下命令（根据你的系统选择）：

**如果是 Alibaba Cloud Linux 或 CentOS**：
```bash
sudo yum install -y libreoffice-headless
```

**如果是 Ubuntu 或 Debian**：
```bash
sudo apt install -y libreoffice --no-install-recommends
```

3. 按回车执行
4. 等待安装完成（约1-2分钟）
5. 验证安装：
```bash
libreoffice --version
```

---

## 第三步：创建数据库（3分钟）

### 3.1 创建数据库

1. 在宝塔面板左侧菜单，点击 **数据库**
2. 点击页面右上角的 **添加数据库** 按钮
3. 填写信息：
   - **数据库名**：`linklore`
   - **用户名**：`linklore_user`
   - **密码**：点击右侧的 **生成** 按钮生成一个强密码，**复制并记录下来**
   - **访问权限**：选择 `本地服务器`
4. 点击 **提交** 按钮
5. 等待创建完成

**记录信息**：
- 数据库名：`linklore`
- 用户名：`linklore_user`
- 密码：`刚才生成的密码`
- 主机：`localhost`
- 端口：`5432`

---

## 第四步：上传项目文件（5分钟）

### 方式1：使用 Git（推荐，如果你有 Git 仓库）

1. 点击宝塔面板左侧的 **终端**
2. 输入以下命令：
```bash
cd /www/wwwroot
```
3. 按回车
4. 输入你的 Git 克隆命令（替换为你的实际仓库地址）：
```bash
git clone https://your-repo-url.git linklore
```
或者如果是 SSH：
```bash
git clone git@github.com:your-username/linklore.git linklore
```
5. 等待克隆完成
6. 验证：
```bash
cd linklore
ls -la
```
应该能看到 `apps/`、`prisma/`、`package.json` 等文件

### 方式2：使用宝塔文件管理器上传

1. 点击宝塔面板左侧的 **文件**
2. 进入 `/www/wwwroot/` 目录
3. 点击页面上的 **上传** 按钮
4. 选择你的项目压缩包（zip 或 tar.gz）
5. 等待上传完成
6. 右键点击压缩包，选择 **解压**
7. 解压后，如果文件夹名不是 `linklore`，请重命名为 `linklore`

---

## 第五步：配置环境变量（10分钟）

### 5.1 生成 SESSION_SECRET

1. 点击宝塔面板左侧的 **终端**
2. 输入命令：
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```
3. 按回车
4. **复制输出的字符串**（这是一串很长的随机字符）

### 5.2 创建环境变量文件

1. 点击宝塔面板左侧的 **文件**
2. 进入 `/www/wwwroot/linklore/apps/web/` 目录
3. 点击页面上的 **新建** 按钮
4. 选择 **文件**
5. 文件名输入：`.env.production`
6. 点击 **创建**

### 5.3 编辑环境变量文件

1. 在文件列表中，找到 `.env.production` 文件
2. 点击文件名（或双击）
3. 在右侧编辑器中，**完全替换**为以下内容（注意：需要替换所有占位符）：

```bash
# ============================================
# 数据库配置（使用刚才创建的数据库信息）
# ============================================
DATABASE_URL="postgresql://linklore_user:你的数据库密码@localhost:5432/linklore"

# ============================================
# 会话密钥（粘贴刚才生成的随机字符串）
# ============================================
SESSION_SECRET="粘贴刚才生成的SESSION_SECRET字符串"

# ============================================
# Redis 配置（使用刚才设置的Redis密码）
# ============================================
REDIS_URL="redis://:你的Redis密码@localhost:6379/0"

# ============================================
# 阿里云 OSS 配置（必须配置）
# ============================================
OSS_REGION="oss-cn-hangzhou"
OSS_ACCESS_KEY_ID="你的阿里云AccessKey ID"
OSS_ACCESS_KEY_SECRET="你的阿里云AccessKey Secret"
OSS_BUCKET="你的OSS Bucket名称"

# ============================================
# AI 配置（可选，保持默认即可）
# ============================================
AI_DEFAULT_PROVIDER="openai"
AI_ALLOWED_PROVIDERS="openai,qwen"
AI_FALLBACK_PROVIDER="qwen"
AI_MONTHLY_USER_CAP_CENTS=500
AI_JOB_COST_LIMIT_CENTS=50

# ============================================
# 队列配置
# ============================================
QUEUE_CONCURRENCY=1

# ============================================
# 文件上传配置
# ============================================
MAX_FILE_SIZE_MB=20
ALLOWED_EXT="doc,docx,txt,md"

# ============================================
# 生产环境配置
# ============================================
NODE_ENV=production
PORT=3000
NEXT_PUBLIC_APP_URL="https://你的域名.com"
```

### 5.4 替换占位符

在编辑器中，将以下内容替换为实际值：

1. **`你的数据库密码`** → 替换为第三步记录的数据库密码
2. **`粘贴刚才生成的SESSION_SECRET字符串`** → 替换为第五步生成的随机字符串
3. **`你的Redis密码`** → 替换为第一步记录的 Redis 密码
4. **`你的阿里云AccessKey ID`** → 替换为你的阿里云 AccessKey ID
5. **`你的阿里云AccessKey Secret`** → 替换为你的阿里云 AccessKey Secret
6. **`你的OSS Bucket名称`** → 替换为你的 OSS Bucket 名称
7. **`你的域名.com`** → 替换为你的实际域名（例如：`www.linklore.com`）

### 5.5 保存文件

1. 点击编辑器右上角的 **保存** 按钮
2. 确认文件已保存

---

## 第六步：部署项目（10分钟）

### 6.1 使用部署脚本（推荐）

1. 点击宝塔面板左侧的 **终端**
2. 输入以下命令：
```bash
cd /www/wwwroot/linklore
```
3. 按回车
4. 输入：
```bash
chmod +x infrastructure/scripts/deploy-bt.sh
```
5. 按回车
6. 输入：
```bash
./infrastructure/scripts/deploy-bt.sh
```
7. 按回车，等待脚本执行完成（约5-10分钟）

**脚本会自动执行**：
- 检查 Node.js、pnpm、PM2
- 安装项目依赖
- 生成 Prisma Client
- 运行数据库迁移
- 构建项目

### 6.2 如果脚本失败，手动执行

如果脚本报错，可以手动执行以下命令：

```bash
cd /www/wwwroot/linklore

# 1. 启用 pnpm
corepack enable
corepack prepare pnpm@9.0.0 --activate

# 2. 安装依赖
pnpm install --frozen-lockfile

# 3. 生成 Prisma Client
pnpm prisma:generate

# 4. 运行数据库迁移
pnpm prisma:migrate

# 5. 构建项目
pnpm build

# 6. 创建日志目录
mkdir -p logs
```

**注意**：每一步执行完成后，再执行下一步。如果某一步报错，请告诉我错误信息。

---

## 第七步：配置 PM2 进程管理（5分钟）

### 7.1 使用宝塔 PM2 管理器（推荐）

1. 在宝塔面板左侧菜单，点击 **软件商店**
2. 找到 **PM2 管理器**，点击 **设置** 按钮
3. 在打开的页面中，点击 **添加 Node 项目** 按钮

#### 添加第一个项目：linklore-web

在添加项目页面，填写：

- **项目名称**：`linklore-web`
- **项目路径**：`/www/wwwroot/linklore`
- **启动文件**：`pnpm`
- **项目参数**：`--filter @linklore/web start`
- **运行目录**：`/www/wwwroot/linklore`
- **Node 版本**：选择 `20.x`（你之前安装的版本）
- **运行模式**：`fork`
- **实例数量**：`1`
- **环境变量**：留空（会自动读取 `.env.production`）

点击 **提交** 按钮

#### 添加第二个项目：linklore-worker

再次点击 **添加 Node 项目**，填写：

- **项目名称**：`linklore-worker`
- **项目路径**：`/www/wwwroot/linklore`
- **启动文件**：`node`
- **项目参数**：`./worker/ai-queue/dist/index.js`
- **运行目录**：`/www/wwwroot/linklore`
- **Node 版本**：选择 `20.x`
- **运行模式**：`fork`
- **实例数量**：`1`
- **环境变量**：留空

点击 **提交** 按钮

#### 添加第三个项目：linklore-baike-scheduler

再次点击 **添加 Node 项目**，填写：

- **项目名称**：`linklore-baike-scheduler`
- **项目路径**：`/www/wwwroot/linklore`
- **启动文件**：`pnpm`
- **项目参数**：`--filter @linklore/web baike:schedule`
- **运行目录**：`/www/wwwroot/linklore`
- **Node 版本**：选择 `20.x`
- **运行模式**：`fork`
- **实例数量**：`1`
- **环境变量**：留空

点击 **提交** 按钮

### 7.2 验证 PM2 状态

1. 在 PM2 管理器页面，应该能看到 3 个项目：
   - `linklore-web`（状态应该是"运行中"）
   - `linklore-worker`（状态应该是"运行中"）
   - `linklore-baike-scheduler`（状态应该是"运行中"）

2. 或者在终端中验证：
```bash
pm2 status
```
应该看到 3 个进程都是绿色的 `online` 状态

---

## 第八步：配置网站和 Nginx（10分钟）

### 8.1 添加网站

1. 在宝塔面板左侧菜单，点击 **网站**
2. 点击页面右上角的 **添加站点** 按钮
3. 填写信息：
   - **域名**：输入你的域名，例如：`www.linklore.com`（如果有 www 和 非 www，可以都输入，用换行或空格分隔）
   - **备注**：`LinkLore`（可选）
   - **根目录**：`/www/wwwroot/linklore`（或保持默认）
   - **FTP**：不创建
   - **数据库**：不创建（我们已经创建了）
   - **PHP 版本**：选择 **纯静态**（不需要 PHP）
4. 点击 **提交** 按钮

### 8.2 配置反向代理

1. 在网站列表中，找到你刚才创建的网站
2. 点击域名右侧的 **设置** 按钮
3. 在打开的页面中，点击顶部的 **反向代理** 标签
4. 点击 **添加反向代理** 按钮
5. 填写信息：
   - **代理名称**：`linklore`
   - **目标 URL**：`http://127.0.0.1:3000`
   - **发送域名**：`$host`
   - 其他选项保持默认
6. 点击 **提交** 按钮

### 8.3 配置 SSL 证书（HTTPS）

1. 在网站设置页面，点击顶部的 **SSL** 标签
2. 在 SSL 证书类型中，选择 **Let's Encrypt**
3. 勾选你的域名（如果添加了 www 和非 www，都勾选）
4. 点击 **申请** 按钮
5. 等待申请完成（约1-2分钟）
6. 申请成功后，开启 **强制 HTTPS** 开关

**注意**：申请 SSL 证书需要域名已正确解析到服务器 IP。如果申请失败，请先检查域名解析。

---

## 第九步：配置防火墙（3分钟）

### 9.1 宝塔面板防火墙

1. 在宝塔面板左侧菜单，点击 **安全**
2. 在 **系统防火墙** 中，确保以下端口已开放：
   - `80` (HTTP)
   - `443` (HTTPS)
   - `22` (SSH)
   - `8888` (宝塔面板，建议修改默认端口)

**注意**：`3000` 端口不需要对外开放，因为只用于本地访问。

### 9.2 阿里云安全组

1. 登录阿里云控制台
2. 进入 **ECS** → **实例**
3. 找到你的服务器，点击 **更多** → **网络和安全组** → **安全组配置**
4. 点击安全组 ID 进入安全组规则
5. 点击 **添加安全组规则**
6. 添加入方向规则：
   - **端口范围**：`80/80`
   - **授权对象**：`0.0.0.0/0`
   - **描述**：`HTTP`
7. 再次添加：
   - **端口范围**：`443/443`
   - **授权对象**：`0.0.0.0/0`
   - **描述**：`HTTPS`

---

## 第十步：验证部署（5分钟）

### 10.1 检查服务状态

1. **检查 PM2**：
   - 在宝塔面板，点击 **软件商店** → **PM2 管理器** → **设置**
   - 确认 3 个进程都在运行

2. **检查端口**：
   - 点击 **终端**，输入：
   ```bash
   netstat -tlnp | grep 3000
   ```
   - 应该能看到 `3000` 端口在监听

### 10.2 访问网站

1. 打开浏览器
2. 访问：`https://你的域名.com`
3. 应该能看到应用首页

### 10.3 健康检查

1. 在浏览器中访问：`https://你的域名.com/api/health`
2. 应该返回 JSON 数据，包含 `"ok": true`

---

## 完成！

如果所有步骤都成功完成，你的网站应该已经可以正常访问了！

**如果遇到任何问题，请告诉我具体的错误信息，我会帮你解决。**

---

## 常见问题快速排查

### 问题：PM2 进程无法启动

**检查**：
1. 在终端执行：`pm2 logs linklore-web --err`
2. 查看错误日志，告诉我错误信息

### 问题：网站显示 502 Bad Gateway

**检查**：
1. 确认 PM2 进程在运行：`pm2 status`
2. 确认端口 3000 在监听：`netstat -tlnp | grep 3000`
3. 检查 Nginx 错误日志：在网站设置 → 日志中查看

### 问题：数据库连接失败

**检查**：
1. 确认 PostgreSQL 在运行（软件商店中查看）
2. 确认 `.env.production` 中的 `DATABASE_URL` 正确
3. 确认数据库密码正确

