# 阿里云服务器部署配置评估（50人同时在线）

## 一、服务器配置推荐

### 1.1 ECS 实例配置（推荐）

**基础配置（最低要求）**：
- **CPU**: 2核
- **内存**: 4GB
- **系统盘**: 40GB SSD
- **带宽**: 3-5Mbps
- **推荐实例**: 阿里云 ecs.t6-c2m1.large 或 ecs.c6.large

**推荐配置（更稳定）**：
- **CPU**: 4核
- **内存**: 8GB
- **系统盘**: 40GB SSD
- **数据盘**: 100GB SSD（用于文件存储，如果不用OSS）
- **带宽**: 5-10Mbps
- **推荐实例**: 阿里云 ecs.c6.xlarge

**预估成本**：
- 基础配置：约 200-300元/月
- 推荐配置：约 400-600元/月

### 1.2 系统要求

- **操作系统**: Ubuntu 22.04 LTS 或 CentOS 7.9+（推荐 Ubuntu）
- **Node.js**: >= 20.11.0
- **pnpm**: >= 9.0.0
- **宝塔面板**: 最新版本

---

## 二、数据库配置（PostgreSQL）

### 2.1 方案选择

**方案A：使用阿里云 RDS PostgreSQL（推荐）**

**配置推荐**：
- **版本**: PostgreSQL 14 或 15
- **规格**: 
  - 基础型：2核2GB（约 200元/月）
  - 高可用型：2核4GB（约 400元/月，推荐）
- **存储**: 20GB SSD（初期足够，可按需扩容）
- **连接数**: 至少 100 个

**优势**：
- 自动备份
- 高可用
- 监控完善
- 无需维护

**方案B：服务器自建 PostgreSQL（成本更低）**

**配置要求**：
- 在 ECS 上安装 PostgreSQL 14+
- 需要额外 2GB 内存
- 需要定期备份

**成本**: 0元（但需要维护）

### 2.2 数据库连接配置

```env
# 使用 RDS
DATABASE_URL="postgresql://username:password@your-rds-host:5432/linklore?sslmode=require"

# 使用自建（同一服务器）
DATABASE_URL="postgresql://postgres:password@localhost:5432/linklore"
```

---

## 三、Redis 配置

### 3.1 方案选择

**方案A：使用阿里云 Redis（推荐）**

**配置推荐**：
- **版本**: Redis 6.0+
- **规格**: 
  - 标准版：1GB 内存（约 100-150元/月）
  - 高可用版：1GB 内存（约 200-300元/月，推荐）
- **连接数**: 至少 1000 个

**优势**：
- 高可用
- 自动备份
- 监控完善

**方案B：服务器自建 Redis（成本更低）**

**配置要求**：
- 在 ECS 上安装 Redis 6.0+
- 需要额外 512MB-1GB 内存
- 建议设置密码

**成本**: 0元（但需要维护）

### 3.2 Redis 连接配置

```env
# 使用云 Redis
REDIS_URL="redis://:password@your-redis-host:6379/0"

# 使用自建（同一服务器）
REDIS_URL="redis://:password@localhost:6379/0"
```

---

## 四、文件存储配置

### 4.1 方案选择

**方案A：使用阿里云 OSS（推荐）**

**配置推荐**：
- **存储类型**: 标准存储
- **存储空间**: 初期 50GB（约 10-15元/月）
- **流量**: 按量付费（约 0.5元/GB）
- **区域**: 选择与服务器相同的区域（降低延迟）

**优势**：
- 无限扩容
- CDN 加速
- 高可用
- 自动备份

**方案B：服务器本地存储（成本更低）**

**配置要求**：
- 需要额外数据盘：100GB SSD（约 50-100元/月）
- 需要定期备份
- 需要监控磁盘空间

**成本**: 约 50-100元/月（数据盘）

### 4.2 OSS 配置

```env
OSS_REGION="oss-cn-hangzhou"  # 根据服务器区域选择
OSS_ACCESS_KEY_ID="your-access-key-id"
OSS_ACCESS_KEY_SECRET="your-access-key-secret"
OSS_BUCKET="linklore-files"
```

---

## 五、带宽需求评估

### 5.1 带宽计算

**50人同时在线估算**：
- 平均每用户：50-100KB/s
- 峰值：100-200KB/s
- 总需求：约 5-10Mbps

**推荐配置**：
- **基础**: 5Mbps（约 200元/月）
- **推荐**: 10Mbps（约 400元/月，更稳定）

**注意**：
- 如果使用 OSS，文件下载流量不计入服务器带宽
- 可以配置 OSS CDN 加速，降低服务器带宽压力

---

## 六、宝塔面板配置

### 6.1 必需软件

1. **Nginx**（反向代理）
   - 版本: 1.20+
   - 用于反向代理和静态文件服务

2. **Node.js**
   - 版本: 20.11.0+
   - 通过宝塔 Node 版本管理器安装

3. **PM2**（进程管理）
   - 版本: 最新
   - 用于管理 Next.js 应用进程

4. **PostgreSQL**（如果自建）
   - 版本: 14+
   - 通过宝塔软件商店安装

5. **Redis**（如果自建）
   - 版本: 6.0+
   - 通过宝塔软件商店安装

### 6.2 防火墙配置

**需要开放的端口**：
- **80**: HTTP
- **443**: HTTPS
- **3000**: Next.js 应用（仅内网访问）
- **5432**: PostgreSQL（仅内网访问，如果自建）
- **6379**: Redis（仅内网访问，如果自建）

**宝塔面板端口**：
- 默认 8888（建议修改为其他端口）

---

## 七、资源需求汇总

### 7.1 最低配置方案（成本优先）

| 服务 | 配置 | 月成本 |
|------|------|--------|
| ECS | 2核4GB, 40GB, 5Mbps | 200-300元 |
| RDS PostgreSQL | 2核2GB, 20GB | 200元 |
| Redis（自建） | 512MB（ECS上） | 0元 |
| OSS | 50GB 标准存储 | 15元 |
| **总计** | | **415-515元/月** |

### 7.2 推荐配置方案（稳定优先）

| 服务 | 配置 | 月成本 |
|------|------|--------|
| ECS | 4核8GB, 40GB+100GB, 10Mbps | 600-800元 |
| RDS PostgreSQL | 2核4GB, 20GB 高可用 | 400元 |
| 云 Redis | 1GB 高可用 | 250元 |
| OSS | 50GB 标准存储 | 15元 |
| **总计** | | **1265-1465元/月** |

### 7.3 混合方案（平衡成本与稳定性）

| 服务 | 配置 | 月成本 |
|------|------|--------|
| ECS | 4核8GB, 40GB+100GB, 10Mbps | 600-800元 |
| RDS PostgreSQL | 2核4GB, 20GB 高可用 | 400元 |
| Redis（自建） | 1GB（ECS上） | 0元 |
| OSS | 50GB 标准存储 | 15元 |
| **总计** | | **1015-1215元/月** |

---

## 八、性能优化建议

### 8.1 Next.js 优化

1. **启用生产模式**
   ```bash
   NODE_ENV=production
   ```

2. **配置 PM2 集群模式**
   ```json
   {
     "instances": 2,  // 根据 CPU 核心数调整
     "exec_mode": "cluster"
   }
   ```

3. **启用缓存**
   - 使用 Redis 缓存
   - 配置 Nginx 缓存静态资源

### 8.2 数据库优化

1. **连接池配置**
   ```env
   DATABASE_URL="postgresql://...?connection_limit=20&pool_timeout=10"
   ```

2. **定期维护**
   - 定期 VACUUM
   - 监控慢查询

### 8.3 存储优化

1. **使用 OSS CDN**
   - 加速文件访问
   - 降低服务器带宽压力

2. **图片压缩**
   - 上传时自动压缩
   - 使用 WebP 格式

---

## 九、监控与备份

### 9.1 监控指标

**必需监控**：
- CPU 使用率（< 80%）
- 内存使用率（< 80%）
- 磁盘使用率（< 80%）
- 数据库连接数
- Redis 内存使用
- 应用响应时间

**推荐工具**：
- 阿里云云监控
- 宝塔监控
- Sentry（错误监控）

### 9.2 备份策略

**数据库备份**：
- RDS：自动备份（每日）+ 手动备份（重要操作前）
- 自建：每日自动备份 + 异地备份

**文件备份**：
- OSS：自动版本控制
- 本地存储：每日自动备份到 OSS 或其他存储

**应用备份**：
- 代码：Git 仓库
- 配置：加密备份到安全位置

---

## 十、安全配置

### 10.1 必需安全措施

1. **SSL 证书**
   - 使用 Let's Encrypt 免费证书（宝塔自动申请）
   - 强制 HTTPS

2. **防火墙**
   - 仅开放必要端口
   - 使用阿里云安全组

3. **数据库安全**
   - 强密码
   - 仅允许内网访问
   - 定期更新

4. **应用安全**
   - 使用强 SESSION_SECRET
   - 启用 CSP 头
   - 定期更新依赖

### 10.2 安全配置示例

**Nginx 安全头**：
```nginx
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "no-referrer" always;
add_header Content-Security-Policy "default-src 'self'; ..." always;
```

---

## 十一、部署步骤概览

### 11.1 准备工作

1. 购买阿里云 ECS 实例
2. 购买 RDS PostgreSQL（或准备自建）
3. 购买云 Redis（或准备自建）
4. 购买 OSS 存储空间
5. 准备域名并备案

### 11.2 服务器初始化

1. 安装宝塔面板
2. 安装必需软件（Nginx, Node.js, PM2）
3. 配置防火墙
4. 安装 PostgreSQL/Redis（如果自建）

### 11.3 应用部署

1. 克隆代码到服务器
2. 配置环境变量
3. 安装依赖并构建
4. 运行数据库迁移
5. 配置 PM2 启动应用
6. 配置 Nginx 反向代理
7. 配置 SSL 证书

### 11.4 测试与监控

1. 功能测试
2. 性能测试
3. 配置监控告警
4. 配置自动备份

---

## 十二、成本优化建议

### 12.1 初期优化

1. **使用自建 Redis**（节省 200-300元/月）
2. **使用本地存储**（节省 15元/月，但需要备份）
3. **选择按量付费**（初期流量少时更便宜）

### 12.2 长期优化

1. **预留实例**（ECS 可节省 30-40%）
2. **包年包月**（比按月付费便宜 10-15%）
3. **OSS 生命周期管理**（自动归档冷数据）

---

## 十三、扩展性考虑

### 13.1 50人 → 100人

**需要升级**：
- ECS: 4核 → 8核
- 内存: 8GB → 16GB
- 带宽: 10Mbps → 20Mbps
- RDS: 2核4GB → 4核8GB

### 13.2 100人 → 500人

**需要升级**：
- 考虑负载均衡
- 数据库读写分离
- Redis 集群
- CDN 加速

---

## 十四、常见问题

### 14.1 性能问题

**Q: 响应慢怎么办？**
- 检查数据库连接数
- 检查 Redis 连接
- 检查 CPU/内存使用率
- 启用缓存

### 14.2 成本问题

**Q: 如何降低成本？**
- 使用自建 Redis
- 使用本地存储（需要备份）
- 选择合适规格（不要过度配置）

### 14.3 安全问题

**Q: 如何保证安全？**
- 定期更新系统
- 使用强密码
- 启用防火墙
- 配置 SSL
- 定期备份

---

## 十五、推荐配置总结

**对于 50 人同时在线，推荐配置**：

1. **ECS**: 4核8GB, 40GB+100GB, 10Mbps（约 600-800元/月）
2. **RDS PostgreSQL**: 2核4GB, 20GB 高可用（约 400元/月）
3. **Redis**: 自建 1GB（0元，或云 Redis 250元/月）
4. **OSS**: 50GB 标准存储（约 15元/月）
5. **总计**: 约 1015-1465元/月

**最低配置（可运行，但可能不稳定）**：
- 总计约 415-515元/月

---

## 十六、下一步行动

1. ✅ 确定预算和配置方案
2. ✅ 购买阿里云服务
3. ✅ 安装宝塔面板
4. ✅ 配置环境变量
5. ✅ 部署应用
6. ✅ 配置监控和备份
7. ✅ 测试和优化

---

**注意**：以上价格为估算，实际价格以阿里云官网为准。建议先购买基础配置，根据实际使用情况再升级。









