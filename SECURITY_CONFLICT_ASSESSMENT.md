# åŠŸèƒ½å†²çªä¸å®‰å…¨æ¼æ´è¯„ä¼°æŠ¥å‘Š

**è¯„ä¼°æ—¶é—´**: 2025-01-XX  
**è¯„ä¼°èŒƒå›´**: FacilitatorPanelã€FacilitatorSidebarã€ChatInputã€AnalysisPanel ç­‰ç¼ºå¤±åŠŸèƒ½çš„æ½œåœ¨å†²çªå’Œå®‰å…¨é£é™©

---

## ä¸€ã€æµå¼è¾“å‡ºç®¡ç†å†²çªåˆ†æ âš ï¸

### 1.1 **å¤šç»„ä»¶åŒæ—¶ä½¿ç”¨ ChatStreamContext**

**æ½œåœ¨å†²çª**:
- `ChatRoom` ä½¿ç”¨ `startStream` å¤„ç† @AI æåŠ
- `FacilitatorPanel` éœ€è¦ä½¿ç”¨ `startStream` å¤„ç† @å…±è¯†ã€@æ€»ç»“ã€@è¯­æ°”
- `SoloPluginPanel` ä½¿ç”¨ `startStream` å¤„ç†æ’ä»¶è°ƒç”¨
- ä¸‰è€…å¯èƒ½åŒæ—¶è§¦å‘æµå¼è¾“å‡º

**å½“å‰ä¿æŠ¤æœºåˆ¶**:
```typescript
// ChatStreamContext.tsx ç¬¬ 45-48 è¡Œ
if (abortControllersRef.current.has(messageId)) {
    abortControllersRef.current.get(messageId)?.abort();
}
```
âœ… **å·²å®ç°**: ç›¸åŒ `messageId` çš„æµä¼šè¢«è‡ªåŠ¨ä¸­æ­¢

**é£é™©è¯„ä¼°**: ğŸŸ¢ **ä½é£é™©**
- æ¯ä¸ªæµä½¿ç”¨å”¯ä¸€çš„ `messageId`
- è‡ªåŠ¨ä¸­æ­¢æœºåˆ¶å·²å®ç°
- ä½†éœ€è¦æ³¨æ„ï¼šå¦‚æœå¤šä¸ªç»„ä»¶ä½¿ç”¨ç›¸åŒçš„ `messageId` ç”Ÿæˆé€»è¾‘ï¼Œå¯èƒ½å†²çª

**å»ºè®®**:
- ç¡®ä¿ `FacilitatorPanel` ä½¿ç”¨å”¯ä¸€çš„ `messageId` ç”Ÿæˆç­–ç•¥ï¼ˆä¾‹å¦‚ï¼š`facilitator-${taskType}-${timestamp}`ï¼‰
- `ChatRoom` ä½¿ç”¨æ¶ˆæ¯IDä½œä¸º `messageId`
- `SoloPluginPanel` ä½¿ç”¨æ’ä»¶ç±»å‹å’Œæ—¶é—´æˆ³

---

### 1.2 **çŠ¶æ€ç®¡ç†å†²çª**

**æ½œåœ¨å†²çª**:
- `ChatRoom` ç»´æŠ¤ `streamingMessageId` çŠ¶æ€
- `FacilitatorPanel` éœ€è¦ç»´æŠ¤è‡ªå·±çš„æµçŠ¶æ€
- ä¸¤è€…å¯èƒ½åŒæ—¶æ›´æ–° `activeStreams` Map

**å½“å‰å®ç°**:
```typescript
// ChatRoom.tsx ç¬¬ 78-83 è¡Œ
const { startStream, getStreamState, clearStream } = useChatStream();
const streamState = streamingMessageId ? getStreamState(streamingMessageId) : null;
```

**é£é™©è¯„ä¼°**: ğŸŸ¢ **ä½é£é™©**
- `ChatStreamContext` ä½¿ç”¨ `Map<string, StreamState>` ç®¡ç†å¤šä¸ªæµ
- æ¯ä¸ªæµç‹¬ç«‹ç®¡ç†ï¼Œäº’ä¸å¹²æ‰°
- ä½†éœ€è¦æ³¨æ„ï¼š`ChatRoom` çš„ `streamingMessageId` åªè·Ÿè¸ªä¸€ä¸ªæµï¼Œå¦‚æœ `FacilitatorPanel` åŒæ—¶å¯åŠ¨æµï¼Œ`ChatRoom` å¯èƒ½æ— æ³•æ­£ç¡®æ˜¾ç¤ºçŠ¶æ€

**å»ºè®®**:
- `FacilitatorPanel` åº”è¯¥ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„æµçŠ¶æ€ï¼Œä¸ä¾èµ– `ChatRoom` çš„ `streamingMessageId`
- ç¡®ä¿ UI æ­£ç¡®æ˜¾ç¤ºå¤šä¸ªåŒæ—¶è¿›è¡Œçš„æµ

---

## äºŒã€æƒé™ä¸å®‰å…¨æ¼æ´åˆ†æ ğŸ”´

### 2.1 **API è·¯ç”±æƒé™æ£€æŸ¥ç¼ºå¤±**

**ä¸¥é‡æ¼æ´**: ğŸ”´ **AI Stream API è·¯ç”±æ–‡ä»¶ä¸ºç©ºï¼ˆ0è¡Œï¼‰**

**æ£€æŸ¥ç»“æœ**:
- âœ… æ–‡ä»¶å­˜åœ¨ï¼š`apps/web/app/api/chat/ai/stream/route.ts`
- âŒ **æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼ˆ0è¡Œï¼‰**
- âŒ **æ²¡æœ‰ä»»ä½•æƒé™æ£€æŸ¥**
- âŒ **æ²¡æœ‰ä»»ä½•è·¯ç”±å¤„ç†é€»è¾‘**

**å½“å‰çŠ¶æ€**:
- å‰ç«¯ä»£ç ï¼ˆ`ChatStreamContext.tsx`ã€`useAiStream.ts`ï¼‰éƒ½åœ¨è°ƒç”¨ `/api/chat/ai/stream`
- ä½†åç«¯è·¯ç”±æ–‡ä»¶å®Œå…¨ä¸ºç©º
- **è¿™æ„å‘³ç€æ‰€æœ‰ AI æµå¼è¯·æ±‚éƒ½ä¼šå¤±è´¥æˆ–è¿”å› 404/500 é”™è¯¯**

**æ½œåœ¨é£é™©**:
1. âŒ **æœªæˆæƒè®¿é—®**: æœªç™»å½•ç”¨æˆ·å¯èƒ½è°ƒç”¨ AI æµå¼ API
2. âŒ **æˆ¿é—´è®¿é—®æ§åˆ¶ç¼ºå¤±**: ç”¨æˆ·å¯èƒ½è®¿é—®å…¶ä»–ç”¨æˆ·çš„æˆ¿é—´
3. âŒ **æˆ¿é—´ç±»å‹éªŒè¯ç¼ºå¤±**: SOLO æˆ¿é—´å¯èƒ½ä½¿ç”¨ DUO çš„ `taskType`ï¼Œåä¹‹äº¦ç„¶
4. âŒ **å‚æ•°æ³¨å…¥**: æ¶æ„ç”¨æˆ·å¯èƒ½æ³¨å…¥ `taskType`ã€`pluginType`ã€`facilitatorMode`

**å¿…é¡»å®ç°çš„æ£€æŸ¥**:
```typescript
// 1. ç™»å½•æ£€æŸ¥
const session = await readSession();
if (!session?.sub) {
    return NextResponse.json({ error: 'æœªç™»å½•' }, { status: 401 });
}

// 2. æˆ¿é—´è®¿é—®æ£€æŸ¥
await requireRoomAccess(roomId, session.sub);

// 3. æˆ¿é—´ç±»å‹éªŒè¯
const room = await prisma.chatRoom.findUnique({
    where: { id: roomId },
    select: { type: true }
});

// 4. å‚æ•°éªŒè¯
if (room.type === 'DUO' && pluginType) {
    return NextResponse.json({ error: 'DUOæˆ¿é—´ä¸èƒ½ä½¿ç”¨pluginType' }, { status: 400 });
}
if (room.type === 'SOLO' && taskType) {
    return NextResponse.json({ error: 'SOLOæˆ¿é—´ä¸èƒ½ä½¿ç”¨taskType' }, { status: 400 });
}
```

**é£é™©è¯„ä¼°**: ğŸ”´ **é«˜é£é™©** - å¿…é¡»ç«‹å³ä¿®å¤

---

### 2.2 **æ¶ˆæ¯åˆ›å»ºæƒé™æ£€æŸ¥**

**å½“å‰å®ç°**:
```typescript
// apps/web/app/api/chat/rooms/[id]/messages/route.ts ç¬¬ 244-262 è¡Œ
const session = await readSession();
if (!session?.sub) {
    return NextResponse.json({ error: 'æœªç™»å½•' }, { status: 401 });
}
await requireRoomAccess(roomId, session.sub);
```

âœ… **å·²å®ç°**: æ¶ˆæ¯åˆ›å»º API æœ‰æƒé™æ£€æŸ¥

**é£é™©è¯„ä¼°**: ğŸŸ¢ **ä½é£é™©**

---

### 2.3 **FacilitatorPanel æƒé™æ£€æŸ¥**

**æ½œåœ¨é£é™©**:
- `FacilitatorPanel` åªèƒ½ç”¨äº DUO æˆ¿é—´
- éœ€è¦ç¡®ä¿åªæœ‰ DUO æˆ¿é—´çš„ç”¨æˆ·æ‰èƒ½è®¿é—®
- éœ€è¦ç¡®ä¿ç”¨æˆ·æ˜¯æˆ¿é—´çš„åˆ›å»ºè€…æˆ–å‚ä¸è€…

**å»ºè®®å®ç°**:
```typescript
// FacilitatorPanel.tsx
useEffect(() => {
    if (roomType !== 'DUO') {
        console.error('[FacilitatorPanel] åªèƒ½ç”¨äºDUOæˆ¿é—´');
        return;
    }
    // éªŒè¯ç”¨æˆ·æƒé™
    verifyUserAccess();
}, [roomId, roomType]);
```

**é£é™©è¯„ä¼°**: ğŸŸ¡ **ä¸­é£é™©** - éœ€è¦åœ¨å‰ç«¯å’Œåç«¯éƒ½è¿›è¡Œæ£€æŸ¥

---

## ä¸‰ã€æ•°æ®ç«äº‰æ¡ä»¶åˆ†æ âš ï¸

### 3.1 **æ¶ˆæ¯åˆ—è¡¨æ›´æ–°ç«äº‰**

**æ½œåœ¨å†²çª**:
- `ChatRoom` é€šè¿‡ SSE æ¥æ”¶æ–°æ¶ˆæ¯
- `FacilitatorPanel` å¯èƒ½åˆ›å»ºæ–°çš„ AI æ¶ˆæ¯
- ä¸¤è€…åŒæ—¶æ›´æ–° `messages` çŠ¶æ€

**å½“å‰å®ç°**:
```typescript
// ChatRoom.tsx ä½¿ç”¨ useChatEvents hook ç›‘å¬ SSE
const { messages: sseMessages } = useChatEvents(roomId);
```

**é£é™©è¯„ä¼°**: ğŸŸ¡ **ä¸­é£é™©**
- å¦‚æœ `FacilitatorPanel` ç›´æ¥æ“ä½œ `messages` çŠ¶æ€ï¼Œå¯èƒ½å†²çª
- å»ºè®®ï¼š`FacilitatorPanel` åˆ›å»ºçš„æ¶ˆæ¯åº”è¯¥é€šè¿‡ SSE äº‹ä»¶åŒæ­¥ï¼Œè€Œä¸æ˜¯ç›´æ¥æ›´æ–°çŠ¶æ€

**å»ºè®®**:
- `FacilitatorPanel` åˆ›å»º AI æ¶ˆæ¯åï¼Œç­‰å¾… SSE äº‹ä»¶æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
- ä¸è¦ç›´æ¥æ“ä½œ `ChatRoom` çš„ `messages` çŠ¶æ€

---

### 3.2 **å…±è¯†åˆ†ææ•°æ®ç«äº‰**

**æ½œåœ¨å†²çª**:
- `AnalysisPanel` å®šæœŸè·å–å…±è¯†åˆ†ææ•°æ®
- `FacilitatorPanel` çš„ @å…±è¯† å‘½ä»¤å¯èƒ½è§¦å‘æ–°çš„åˆ†æ
- ä¸¤è€…å¯èƒ½åŒæ—¶è¯·æ±‚ `/api/chat/rooms/${roomId}/analysis`

**é£é™©è¯„ä¼°**: ğŸŸ¢ **ä½é£é™©**
- åˆ†æ API åº”è¯¥æ˜¯å¹‚ç­‰çš„
- å¤šä¸ªè¯·æ±‚åº”è¯¥è¿”å›ç›¸åŒç»“æœæˆ–è§¦å‘ä¸€æ¬¡åˆ†æ

---

## å››ã€UI çŠ¶æ€å†²çªåˆ†æ âš ï¸

### 4.1 **ChatInput @æåŠåŠŸèƒ½å†²çª**

**æ½œåœ¨å†²çª**:
- `ChatRoom` çš„ `handleMentionSelect` åªå¤„ç†"æ›´æ¢è¯é¢˜"
- `FacilitatorPanel` éœ€è¦å¤„ç† @å…±è¯†ã€@æ€»ç»“ã€@è¯­æ°”
- ä¸¤è€…å¯èƒ½åŒæ—¶å¤„ç†åŒä¸€ä¸ª @å‘½ä»¤

**å½“å‰å®ç°**:
```typescript
// ChatRoom.tsx ç¬¬ 561-565 è¡Œ
const handleMentionSelect = (mention: string) => {
    if (mention === 'æ›´æ¢è¯é¢˜') {
        setShowTopicChangeDialog(true);
    }
};
```

**é£é™©è¯„ä¼°**: ğŸŸ¡ **ä¸­é£é™©**
- å¦‚æœ `ChatInput` åŒæ—¶è§¦å‘å¤šä¸ª `onMentionSelect` å›è°ƒï¼Œå¯èƒ½å†²çª
- å»ºè®®ï¼šç»Ÿä¸€ @å‘½ä»¤å¤„ç†æœºåˆ¶

**å»ºè®®**:
- åˆ›å»ºç»Ÿä¸€çš„ `@CommandHandler` ç»„ä»¶
- æ ¹æ®æˆ¿é—´ç±»å‹å’Œå‘½ä»¤ç±»å‹è·¯ç”±åˆ°æ­£ç¡®çš„å¤„ç†å™¨

---

### 4.2 **FacilitatorSidebar æ˜¾ç¤ºå†²çª**

**æ½œåœ¨å†²çª**:
- `FacilitatorSidebar` åº”è¯¥åœ¨ DUO æˆ¿é—´æ˜¾ç¤º
- `ChatSidebar` å·²ç»åœ¨å·¦ä¾§æ˜¾ç¤º
- ä¸¤è€…å¯èƒ½åŒæ—¶å ç”¨å±å¹•ç©ºé—´

**é£é™©è¯„ä¼°**: ğŸŸ¢ **ä½é£é™©**
- `FacilitatorSidebar` åº”è¯¥åœ¨å³ä¾§ï¼Œ`ChatSidebar` åœ¨å·¦ä¾§
- éœ€è¦ç¡®ä¿å“åº”å¼å¸ƒå±€æ­£ç¡®

---

## äº”ã€API è°ƒç”¨é¢‘ç‡ä¸èŠ‚æµ âš ï¸

### 5.1 **èŠ‚æµæœºåˆ¶ç¼ºå¤±**

**æ½œåœ¨é£é™©**:
- `FacilitatorPanel` çš„æŒ‰é’®å¯èƒ½è¢«å¿«é€Ÿç‚¹å‡»
- æ¯æ¬¡ç‚¹å‡»éƒ½ä¼šåˆ›å»ºæ–°çš„ AI æ¶ˆæ¯å’Œæµ
- å¯èƒ½å¯¼è‡´ API è°ƒç”¨è¿‡è½½

**å½“å‰çŠ¶æ€**:
- `throttle.ts` å·²åˆ›å»ºä½†æœªé›†æˆï¼ˆæ ¹æ® `AI_FEATURES_CHECKLIST.md`ï¼‰

**é£é™©è¯„ä¼°**: ğŸŸ¡ **ä¸­é£é™©**
- éœ€è¦åœ¨å‰ç«¯å®ç°æŒ‰é’®ç¦ç”¨é€»è¾‘
- éœ€è¦åœ¨åç«¯å®ç°èŠ‚æµæ£€æŸ¥

**å»ºè®®**:
```typescript
// FacilitatorPanel.tsx
const [isProcessing, setIsProcessing] = useState(false);

const handleConsensusAnalysis = async () => {
    if (isProcessing) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
    setIsProcessing(true);
    try {
        // è°ƒç”¨åˆ†æ
    } finally {
        setIsProcessing(false);
    }
};
```

---

## å…­ã€æ€»ç»“ä¸å»ºè®®

### âœ… **å·²ä¿®å¤çš„ä¸¥é‡æ¼æ´**

1. **AI Stream API è·¯ç”±æƒé™æ£€æŸ¥** âœ… **å·²ä¿®å¤**
   - âœ… å·²å®ç°å®Œæ•´çš„æƒé™æ£€æŸ¥ï¼ˆç™»å½•æ£€æŸ¥ã€æˆ¿é—´è®¿é—®æ£€æŸ¥ï¼‰
   - âœ… å·²å®ç°æˆ¿é—´ç±»å‹éªŒè¯ï¼ˆDUO/SOLO å‚æ•°éªŒè¯ï¼‰
   - âœ… å·²å®ç°å‚æ•°éªŒè¯ï¼ˆZod schemaï¼‰
   - âœ… å·²å®ç°æµå¼è¾“å‡ºå¤„ç†ï¼ˆSSEï¼‰
   - âœ… å·²å®ç°æ¶ˆæ¯æ›´æ–°é€»è¾‘

### ğŸŸ¡ **ä¸­ç­‰é£é™©ï¼ˆéœ€è¦ä¿®å¤ï¼‰**

2. **@å‘½ä»¤å¤„ç†æœºåˆ¶ä¸ç»Ÿä¸€**
   - å»ºè®®åˆ›å»ºç»Ÿä¸€çš„ `@CommandHandler`
   - æ ¹æ®æˆ¿é—´ç±»å‹å’Œå‘½ä»¤ç±»å‹è·¯ç”±

3. **èŠ‚æµæœºåˆ¶æœªé›†æˆ**
   - å‰ç«¯éœ€è¦æŒ‰é’®ç¦ç”¨é€»è¾‘
   - åç«¯éœ€è¦èŠ‚æµæ£€æŸ¥

4. **FacilitatorPanel æƒé™æ£€æŸ¥**
   - å‰ç«¯å’Œåç«¯éƒ½éœ€è¦éªŒè¯æˆ¿é—´ç±»å‹å’Œç”¨æˆ·æƒé™

### ğŸŸ¢ **ä½é£é™©ï¼ˆå»ºè®®ä¼˜åŒ–ï¼‰**

5. **æµå¼è¾“å‡ºçŠ¶æ€ç®¡ç†**
   - ç¡®ä¿ `FacilitatorPanel` ä½¿ç”¨å”¯ä¸€çš„ `messageId`
   - ç¡®ä¿ UI æ­£ç¡®æ˜¾ç¤ºå¤šä¸ªåŒæ—¶è¿›è¡Œçš„æµ

6. **æ¶ˆæ¯åˆ—è¡¨æ›´æ–°**
   - `FacilitatorPanel` åº”è¯¥é€šè¿‡ SSE åŒæ­¥æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯ç›´æ¥æ›´æ–°çŠ¶æ€

---

## ä¸ƒã€ä¿®å¤ä¼˜å…ˆçº§

1. **P0ï¼ˆç«‹å³ä¿®å¤ï¼‰**: AI Stream API æƒé™æ£€æŸ¥
2. **P1ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰**: @å‘½ä»¤ç»Ÿä¸€å¤„ç†æœºåˆ¶
3. **P2ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰**: èŠ‚æµæœºåˆ¶é›†æˆ
4. **P3ï¼ˆä½ä¼˜å…ˆçº§ï¼‰**: UI çŠ¶æ€ç®¡ç†ä¼˜åŒ–

---

## å…«ã€å®‰å…¨å»ºè®®

1. **æ‰€æœ‰ API è·¯ç”±å¿…é¡»å®ç°**:
   - ç™»å½•æ£€æŸ¥ (`session?.sub`)
   - æˆ¿é—´è®¿é—®æ£€æŸ¥ (`requireRoomAccess`)
   - æˆ¿é—´ç±»å‹éªŒè¯
   - å‚æ•°éªŒè¯ï¼ˆZod schemaï¼‰

2. **å‰ç«¯ç»„ä»¶å¿…é¡»å®ç°**:
   - æˆ¿é—´ç±»å‹æ£€æŸ¥
   - ç”¨æˆ·æƒé™éªŒè¯
   - æŒ‰é’®ç¦ç”¨é€»è¾‘ï¼ˆé˜²æ­¢é‡å¤ç‚¹å‡»ï¼‰
   - é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

3. **æµå¼è¾“å‡ºç®¡ç†**:
   - ä½¿ç”¨å”¯ä¸€çš„ `messageId`
   - å®ç°è‡ªåŠ¨ä¸­æ­¢æœºåˆ¶ï¼ˆå·²å®ç°ï¼‰
   - æ­£ç¡®å¤„ç†é”™è¯¯å’Œæ¸…ç†èµ„æº

