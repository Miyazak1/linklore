# 语义溯源系统业务文档

## 概述

语义溯源系统是一个用于还原概念、事实、事件等语义内容的平台。编辑通过查找和引用资料，尽可能贴近真相地还原目标内容，AI 评估其可信度，高可信度的溯源会被采纳为词条。

## 核心概念

### 溯源（Trace）

溯源是编辑提交的语义还原内容，包含：
- **目标**: 要还原的概念/事实/事件等
- **类型**: CONCEPT（概念）、EVENT（事件）、FACT（事实）、PERSON（人物）、THEORY（理论）、DEFINITION（定义）
- **正文**: Markdown 格式的正文内容
- **引用**: 结构化的引用列表，包含 URL、标题、作者、出版机构、年份等

### 词条（Entry）

词条是经过 AI 评估、可信度足够高的溯源，被采纳后形成的知识条目。词条具有：
- **唯一 slug**: URL 友好的标识符
- **版本管理**: 支持版本更新
- **来源追溯**: 记录来源溯源和编辑信息

### 状态流转

```
DRAFT → PUBLISHED → ANALYZING → APPROVED
  ↑                    ↓
  └────────────────────┘
```

- **DRAFT**: 草稿状态，编辑中
- **PUBLISHED**: 已发布，等待 AI 分析
- **ANALYZING**: AI 分析中
- **APPROVED**: 已批准，已创建词条

## 工作流程

### 1. 创建溯源

编辑创建新的溯源：
1. 填写标题、类型、目标描述
2. 编写正文（Markdown 格式）
3. 添加引用（URL、标题、作者等）
4. 在正文中插入引用标记 `[N]`
5. 保存为草稿或直接发布

### 2. AI 分析

发布后，系统自动触发 AI 分析：
1. 评估可信度（0-1 分，核心指标）
2. 评估完整性（0-1 分）
3. 评估准确性（0-1 分）
4. 评估来源质量（0-1 分）
5. 生成优点、不足、缺失方面、改进建议
6. 判断是否可以批准（可信度 ≥ 0.7）

### 3. 批准为词条

如果 AI 评估可信度 ≥ 0.7，编辑可以批准溯源：
1. 系统自动生成唯一 slug
2. 创建词条记录
3. 将溯源状态更新为 APPROVED
4. 词条可在词条列表中查看

### 4. 词条更新

词条支持版本更新：
1. 编辑可以标记词条需要更新
2. 创建新的溯源来更新词条
3. 新溯源批准后，词条版本号递增

## 权限系统

### 角色

- **member**: 普通成员，只能查看词条
- **editor**: 编辑，可以创建和管理自己的溯源
- **admin**: 管理员，可以管理所有溯源和词条，设置用户权限

### 权限规则

- 编辑只能查看和管理自己创建的溯源
- 管理员可以查看和管理所有溯源
- 词条对所有用户可见
- 批准溯源需要 editor 或 admin 角色

## AI 评估标准

### 可信度（Credibility）

核心指标，决定是否可以批准：
- **0.0-0.3**: 不可信（存在明显错误、来源不可靠、逻辑混乱）
- **0.4-0.6**: 部分可信（有一定依据但不够充分）
- **0.7-0.8**: 可信（依据充分、逻辑清晰）
- **0.9-1.0**: 高度可信（来源权威、证据充分、逻辑严密）

**批准阈值**: 可信度 ≥ 0.7

### 完整性（Completeness）

评估是否充分还原了目标：
- **0.0-0.3**: 不完整（遗漏大量关键信息）
- **0.4-0.6**: 部分完整（覆盖主要方面但不够深入）
- **0.7-0.8**: 较完整（覆盖主要方面且有一定深度）
- **0.9-1.0**: 完整（全面覆盖且深入）

### 准确性（Accuracy）

评估内容的准确性：
- **0.0-0.3**: 不准确（存在明显错误）
- **0.4-0.6**: 部分准确（基本准确但有小错误）
- **0.7-0.8**: 准确（基本无误）
- **0.9-1.0**: 高度准确（完全准确）

### 来源质量（Source Quality）

评估引用的来源质量：
- **0.0-0.3**: 来源质量差（来源不可靠、不相关）
- **0.4-0.6**: 来源质量一般（部分可靠但不够多样）
- **0.7-0.8**: 来源质量良好（来源可靠且相关）
- **0.9-1.0**: 来源质量优秀（来源权威、多样、相关、时效性好）

## 引用规范

### 引用类型

- **WEB**: 网页
- **BOOK**: 书籍
- **ARTICLE**: 文章
- **PAPER**: 论文
- **OTHER**: 其他

### 引用字段

- **url**: 链接（可选）
- **title**: 标题（必需）
- **author**: 作者（可选）
- **publisher**: 出版机构（可选）
- **year**: 年份（可选）
- **quote**: 引用片段（可选）
- **page**: 页码（可选）

### 引用标记

在正文中使用 `[N]` 格式标记引用，例如：
```
这是正文内容[1]，还有更多内容[2]。
```

## 草稿系统

### 自动保存

- 每 30 秒自动保存草稿
- 保存到 IndexedDB（主要存储）
- 备份到 localStorage（降级方案）
- 同步到服务器（跨设备访问）

### 草稿恢复

- 打开编辑器时自动恢复草稿
- 优先从服务器加载
- 如果服务器没有，从本地加载
- 恢复后自动同步到所有存储

## 性能优化

### 缓存策略

- **词条缓存**: TTL 1 小时
- **溯源缓存**: TTL 30 分钟
- **分析结果缓存**: 基于内容 hash，避免重复分析

### 查询优化

- 使用数据加载器批量加载
- 索引优化（数据库索引）
- 分页查询

### 前端优化

- React.memo 优化列表项渲染
- 懒加载图片
- 虚拟滚动（大量数据时）

## 监控指标

系统收集以下监控指标：
- 溯源总数、按状态/类型分布
- 词条总数、需要更新的数量
- 用户总数、按角色分布
- 分析总数、平均处理时间、成功率
- 缓存命中率

## 安全考虑

### 输入验证

- 使用 Zod Schema 验证所有输入
- 正文长度限制（最小 10 字符，最大 50000 字符）
- 引用数量限制（最多 50 个）
- URL 格式验证

### 权限控制

- 所有 API 都需要认证
- 编辑只能访问自己的溯源
- 管理员可以访问所有资源
- 审计日志记录所有关键操作

### 限流

- 创建/更新溯源: 每分钟 10 次
- 发布溯源: 每小时 5 次
- 其他操作: 每分钟 30 次

## 未来规划

- 实时协作编辑
- 冲突检测和解决
- 更丰富的引用类型支持
- 词条版本对比
- 社区评审机制

