# AI 功能实现检查清单

基于计划的完整功能检查报告

## ✅ 已实现功能

### 1. 核心架构
- ✅ 风险评估系统（`risk-assessor.ts`）
  - 0-4级风险分级
  - 多维度检测（指向性、情绪强度、价值判断等）
- ✅ 输出过滤系统（`output-filter.ts`）
  - AI输出二次扫描
  - 重试机制
  - 拒答模板
- ✅ Prompt模板系统
  - ✅ DUO房间：Facilitator v1/v2/v3 三种模式
  - ✅ SOLO房间：8个插件Prompt
  - ✅ 风险等级对应的约束Prompt
- ✅ 保守模式（`conservative-mode.ts`）
  - 环境变量配置
  - 风险等级限制
  - 插件/任务禁用功能

### 2. DUO房间功能
- ✅ 右侧栏组件（`FacilitatorSidebar.tsx`）
  - 可收缩/展开
  - AI消息隔离显示
- ✅ FacilitatorPanel（4个标签页）
  - ✅ 结构分析
  - ✅ 共识/分歧
  - ✅ 语气提醒
  - ✅ 共识趋势
- ✅ @命令集成
  - ✅ @共识
  - ✅ @总结（结构）
  - ✅ @语气
- ✅ AnalysisPanel（共识趋势）

### 3. SOLO房间功能
- ✅ 8大插件全部实现
  - ✅ 概念澄清器
  - ✅ 推理链路分析
  - ✅ 结构化写作
  - ✅ 深度问答引导
  - ✅ 对立视角生成
  - ✅ 学习引导
  - ✅ 思想日志
  - ✅ 实践框架
- ✅ 自动推荐插件（基于关键词）

### 4. 监控与节流
- ✅ 监控模块（`monitoring.ts`）- 仅日志
- ✅ 节流模块（`throttle.ts`）- 已创建但未集成

---

## ❌ 遗漏和未完成功能

### 1. 自动触发机制（重要遗漏）
**计划要求**：DUO房间应自动检测并触发AI提示
- ❌ **未实现**：自动检测情绪激烈、循环重复、偏离主题等情况
- ❌ **未实现**：自动触发语气提醒、结构总结
- **位置**：应该在 `ChatRoom.tsx` 或 `FacilitatorPanel.tsx` 中监听消息并自动触发
- **建议**：在消息更新时检测关键词/情绪词，如果符合条件且通过节流检查，自动触发对应任务

### 2. 节流机制未集成（重要遗漏）
**计划要求**：自动提示应该被节流，避免过于频繁
- ❌ **未实现**：`throttle.ts` 已创建但未在API路由中使用
- ❌ **未实现**：自动触发前没有调用 `canTriggerAutoPrompt`
- **位置**：应该在触发自动提示前检查 `canTriggerAutoPrompt(roomId, triggerType)`
- **建议**：在自动触发逻辑中集成节流检查

### 3. @资料功能不完整
**计划要求**：@资料应触发 `library` 任务，返回书籍章节索引
- ⚠️ **部分实现**：ChatInput中有@资料选项，但只是打开BookSearchDialog
- ❌ **未实现**：没有实现调用AI的library任务（taskType='library'）
- ❌ **未实现**：AI应返回书籍章节索引，而不是打开对话框
- **建议**：实现library任务类型，让AI根据用户输入推荐相关书籍和章节

### 4. FacilitatorMode切换UI缺失
**计划要求**：用户应该能够切换v1/v2/v3模式
- ❌ **未实现**：没有UI让用户选择使用哪个模式
- ❌ **未实现**：数据库schema中没有存储房间的facilitatorMode偏好
- **建议**：在FacilitatorSidebar或房间设置中添加模式切换

### 5. 监控数据未持久化
**计划要求**：记录AI调用指标用于分析
- ⚠️ **部分实现**：只记录到console.log
- ❌ **未实现**：没有数据库表存储监控数据
- ❌ **未实现**：无法查询统计信息
- **建议**：创建 `ai_call_logs` 表，记录所有调用指标

### 6. 房间级别的FacilitatorMode存储
**计划要求**：每个房间应该可以设置自己的主持人模式
- ❌ **未实现**：没有数据库字段存储 `facilitatorMode`
- ❌ **未实现**：每次调用都使用默认v1模式
- **建议**：在 `chatRoom` 表中添加 `facilitatorMode` 字段

---

## 🔧 需要优化的地方

### 1. 右侧栏的padding调整方式
**当前**：使用DOM查询 `document.querySelector`
**问题**：不够React化，可能不稳定
**建议**：使用React state或ref直接管理

### 2. FacilitatorPanel消息追踪
**当前**：通过回调通知父组件
**问题**：如果FacilitatorPanel内部直接创建消息，可能遗漏
**建议**：确保所有消息创建路径都调用回调

### 3. 自动推荐的准确性
**当前**：基于简单关键词匹配
**建议**：可以改进为更智能的推荐算法

### 4. 错误处理
**当前**：部分错误处理可能不够完善
**建议**：增加更详细的错误日志和用户提示

---

## 📋 优先级排序

### 高优先级（必须实现）
1. **自动触发机制**：计划中明确要求的核心功能
2. **节流机制集成**：防止自动提示过于频繁
3. **@资料功能完善**：计划中提到的library任务

### 中优先级（建议实现）
4. **FacilitatorMode切换UI**：提升用户体验
5. **监控数据持久化**：用于后续分析和优化

### 低优先级（可选）
6. **右侧栏优化**：当前方式可用，可以后续优化
7. **推荐算法改进**：当前版本已可用

---

## 🎯 下一步行动建议

1. 实现自动触发机制（在ChatRoom中监听消息，检测条件后自动触发）
2. 集成节流机制（在自动触发前检查）
3. 完善@资料功能（实现library任务）
4. 添加FacilitatorMode切换UI
5. 创建监控数据表并持久化













