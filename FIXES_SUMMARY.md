# å®‰å…¨æ¼æ´ä¿®å¤æ€»ç»“

**ä¿®å¤æ—¶é—´**: 2025-01-XX  
**ä¿®å¤å†…å®¹**: AI Stream API è·¯ç”±å®Œæ•´å®ç°

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. AI Stream API è·¯ç”±å®ç° (`apps/web/app/api/chat/ai/stream/route.ts`)

**ä¿®å¤å‰çŠ¶æ€**:
- âŒ æ–‡ä»¶å®Œå…¨ä¸ºç©ºï¼ˆ0è¡Œä»£ç ï¼‰
- âŒ æ‰€æœ‰ AI æµå¼è¯·æ±‚éƒ½ä¼šå¤±è´¥
- âŒ æ²¡æœ‰ä»»ä½•å®‰å…¨ä¿æŠ¤

**ä¿®å¤åçŠ¶æ€**:
- âœ… å®Œæ•´çš„æƒé™æ£€æŸ¥ï¼ˆç™»å½•ã€æˆ¿é—´è®¿é—®ï¼‰
- âœ… æˆ¿é—´ç±»å‹éªŒè¯ï¼ˆDUO/SOLO å‚æ•°éªŒè¯ï¼‰
- âœ… å‚æ•°éªŒè¯ï¼ˆZod schemaï¼‰
- âœ… æµå¼è¾“å‡ºå¤„ç†ï¼ˆSSE æ ¼å¼ï¼‰
- âœ… æ¶ˆæ¯æ›´æ–°é€»è¾‘
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**å®ç°çš„å®‰å…¨æ£€æŸ¥**:

1. **ç™»å½•æ£€æŸ¥**
   ```typescript
   const session = await readSession();
   if (!session?.sub) {
       return NextResponse.json({ error: 'æœªç™»å½•' }, { status: 401 });
   }
   ```

2. **æˆ¿é—´è®¿é—®æ£€æŸ¥**
   ```typescript
   await requireRoomAccess(roomId, session.sub);
   ```

3. **æˆ¿é—´ç±»å‹éªŒè¯**
   ```typescript
   if (room.type === 'DUO' && pluginType) {
       return NextResponse.json(
           { error: 'DUOæˆ¿é—´ä¸èƒ½ä½¿ç”¨pluginType' },
           { status: 400 }
       );
   }
   if (room.type === 'SOLO' && taskType) {
       return NextResponse.json(
           { error: 'SOLOæˆ¿é—´ä¸èƒ½ä½¿ç”¨taskType' },
           { status: 400 }
       );
   }
   ```

4. **å‚æ•°éªŒè¯ï¼ˆZodï¼‰**
   ```typescript
   const StreamRequestSchema = z.object({
       messageId: z.string(),
       roomId: z.string(),
       prompt: z.string(),
       context: z.array(...).optional(),
       taskType: z.enum([...]).optional(),
       pluginType: z.enum([...]).optional(),
       facilitatorMode: z.enum(['v1', 'v2', 'v3']).optional()
   });
   ```

5. **æ¶ˆæ¯æƒé™éªŒè¯**
   ```typescript
   if (message.senderId !== session.sub) {
       return NextResponse.json({ error: 'æ— æƒæ“ä½œæ­¤æ¶ˆæ¯' }, { status: 403 });
   }
   ```

**åŠŸèƒ½å®ç°**:

- âœ… DUO æˆ¿é—´æ”¯æŒ `taskType`ï¼ˆstructure, tone, consensus, libraryï¼‰
- âœ… SOLO æˆ¿é—´æ”¯æŒ `pluginType`ï¼ˆ8å¤§æ’ä»¶ï¼‰
- âœ… æ”¯æŒ `facilitatorMode`ï¼ˆv1, v2, v3ï¼‰
- âœ… è‡ªåŠ¨æ„å»º AI messagesï¼ˆæ ¹æ®æˆ¿é—´ç±»å‹å’Œå‚æ•°ï¼‰
- âœ… SSE æµå¼å“åº”ï¼ˆtext/event-streamï¼‰
- âœ… æµå®Œæˆåè‡ªåŠ¨æ›´æ–°æ¶ˆæ¯å†…å®¹
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

---

## ğŸ“‹ å¾…å¤„ç†çš„ä»»åŠ¡

### 1. ç»Ÿä¸€ @å‘½ä»¤å¤„ç†æœºåˆ¶
- åˆ›å»º `@CommandHandler` ç»„ä»¶
- æ ¹æ®æˆ¿é—´ç±»å‹å’Œå‘½ä»¤ç±»å‹è·¯ç”±åˆ°æ­£ç¡®çš„å¤„ç†å™¨

### 2. é›†æˆèŠ‚æµæœºåˆ¶
- å‰ç«¯æŒ‰é’®ç¦ç”¨é€»è¾‘
- åç«¯èŠ‚æµæ£€æŸ¥ï¼ˆ`throttle.ts` å·²åˆ›å»ºä½†æœªé›†æˆï¼‰

---

## ğŸ”’ å®‰å…¨çŠ¶æ€

**ä¿®å¤å‰**: ğŸ”´ **é«˜é£é™©** - æ–‡ä»¶ä¸ºç©ºï¼Œæ— ä»»ä½•ä¿æŠ¤  
**ä¿®å¤å**: ğŸŸ¢ **å®‰å…¨** - å®Œæ•´çš„æƒé™æ£€æŸ¥å’Œå‚æ•°éªŒè¯

---

## ğŸ“ æµ‹è¯•å»ºè®®

1. **æƒé™æµ‹è¯•**:
   - æœªç™»å½•ç”¨æˆ·åº”è¿”å› 401
   - æ— æƒé™ç”¨æˆ·åº”è¿”å› 403
   - é”™è¯¯çš„æˆ¿é—´ç±»å‹å‚æ•°åº”è¿”å› 400

2. **åŠŸèƒ½æµ‹è¯•**:
   - DUO æˆ¿é—´ä½¿ç”¨ `taskType` åº”æ­£å¸¸å·¥ä½œ
   - SOLO æˆ¿é—´ä½¿ç”¨ `pluginType` åº”æ­£å¸¸å·¥ä½œ
   - æµå¼è¾“å‡ºåº”æ­£ç¡®è¿”å› SSE æ ¼å¼
   - æ¶ˆæ¯å†…å®¹åº”åœ¨æµå®Œæˆåæ›´æ–°

3. **é”™è¯¯å¤„ç†æµ‹è¯•**:
   - AI API è°ƒç”¨å¤±è´¥åº”æ­£ç¡®å¤„ç†
   - ç½‘ç»œä¸­æ–­åº”æ­£ç¡®å¤„ç†
   - æ— æ•ˆå‚æ•°åº”è¿”å›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯






